<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Weather Station Select</title>
    <script>
        var map, infoWindow, start = [];
        document.addEventListener("click", function(e) {
            if (e.target.className.split(" ").indexOf("selectPWS") > -1) {
                window.top.postMessage({"PWS": e.target.dataset.id},"*");
            }
        }, false);
        window.onload = function(){
            initialize(start[0],start[1]);
        };
        function initialize(lat,lon) {
            var myLatlng = new google.maps.LatLng( lat, lon );
            var myOptions = {
                zoom: 15,
                center: myLatlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            }
            map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
            infoWindow = new google.maps.InfoWindow;
        }
        window.onmessage = function(e) {
            var data = e.data;
            if (data.type === "currentLocation") {
                start = [data.payload.lat,data.payload.lon];
                plotMarker("orgin",{message: "Current Location"},data.payload.lat,data.payload.lon);
            } else if (data.type === "pwsData") {
                data = JSON.parse(decodeURIComponent(data.payload));
                var bounds = new google.maps.LatLngBounds();

                for (var i=0; i<data.length; i++) {
                    plotMarker("pws",data[i],data[i].lat,data[i].lon);
                    bounds.extend( new google.maps.LatLng( data[i].lat,data[i].lon ) );
                }
                map.fitBounds(bounds);
                map.panToBounds(bounds);
            }
        }
        function plotMarker(type,data,lat,lon){
            var marker = new google.maps.Marker({
                position: new google.maps.LatLng(lat,lon),
                map: map,
                icon: (type === "orgin" ? "http://maps.google.com/mapfiles/ms/icons/red-dot.png" : "http://maps.google.com/mapfiles/ms/icons/blue-dot.png")
            });

            google.maps.event.addListener(marker, "click", function(){
                infoWindow.close();
                html = (type === "orgin" ? data.message : createInfoWindow(data));
                infoWindow = new google.maps.InfoWindow({
                    content: html
                });
                infoWindow.open(map, marker);
            })
        }

        function createInfoWindow(data) {
            return "<div style='height:80px;text-align:center'><h3 style='padding:0;margin:0 0 4px 0'>"+(data.city ? data.city+", " : "")+(data.state ? data.state+", " : "")+data.country+"</h3>"+data.neighborhood+"<br>"+data.distance_mi+" miles away<br><button class='selectPWS' data-id='"+data.id+"'>Select</button></div>";
        }
    </script>
    <script src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <style>
        html {
            height: 100%;
            overflow: hidden;
        }
        body {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        #map_canvas {
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="map_canvas"></div>
</body>
</html>
